<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title th:text="'LangTrip | '+${videoData.title}"></title>
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css"
	rel="stylesheet">
<link
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
	rel="stylesheet">
<link rel="stylesheet" th:href="@{/css/video_frm.css}">
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
	<div class="container">
		<input type="hidden" id="courseSeq" th:value="${courseSeq}" /> 
		<input type="hidden" id="userSeq" th:value="${userSeq}" /> 
		<input type="hidden" id="videoSeq" th:value="${videoData.videoSeq}" />
		<input type="hidden" id="from" th:value="${from}" />
		
		<!-- 여행 헤더 -->
		<div class="travel-header">
			<a th:href="@{/ui/user_registered_course(seq=${courseSeq})}" class="travel-close-btn">&#x2715;</a>
			<!-- ui/user_registered_course?seq=${courseSeq} 분기 처리 -->
			<h1 class="travel-title">🌍 English Travel Adventure</h1>
			<div class="travel-subtitle">
				<i class="fas fa-route"></i> <span>언어와 함께 떠나는 특별한 여행</span> 
				<i class="fas fa-globe-americas"></i>
			</div>
		</div>

		<div class="row gx-4" style="display: flex;">
			<!-- 왼쪽: 비디오 및 자막 -->
			<div class="col-lg-8 d-flex">
				<div class="video-container w-100">
					<h2 class="video-title">
						<i class="fas fa-play-circle"></i> 
						  <span th:text="${videoData.title}">영상 제목</span>
					</h2>
					<p class="video-desc" th:text="${videoData.description}">영상 설명</p>
					<div class="video-wrapper">
						<video id="videoPlayer" class="video-element" controls>
							<source th:src="@{${videoData.filePath}}" type="video/mp4" />
						</video>
					</div>
				</div>

				
			</div>

			<!-- 오른쪽: 진행 상태 -->
			<div class="col-lg-4 d-flex">
				<div class="learning-sidebar w-100 h-100">
					<h5 class="sidebar-title">
						<i class="fas fa-compass"></i> 학습 여행지
					</h5>
					<div class="current-topic">
						<i class="fas fa-map-marker-alt"></i> 인사 표현하기
					</div>
					<div class="progress-section">
						<div
							class="d-flex justify-content-between align-items-center mb-3">
							<span
								style="color: var(--primary-blue); font-weight: 600; font-size: 1rem;">여행
								진행도</span> <span
								style="color: var(--travel-accent); font-weight: 700; font-size: 1.1rem;"></span>
						</div>
						<div class="progress">
							<div class="progress-bar progress-bar-custom" role="progressbar"
								style="width: 0%;" aria-valuenow="0" aria-valuemin="0"
								aria-valuemax="100">0%</div>
						</div>
					</div>


					<div class="quiz-section">
						<div class="quiz-question">
							<i class="fas fa-puzzle-piece"></i> 오늘의 여행 미션
						</div>
						<div class="quiz-content">
							<p>
								<strong>&lt;신기하네&gt;는 영어로?</strong>
							</p>
							<p>That's a ___.</p>
							<hr
								style="border-color: rgba(255, 179, 71, 0.4); margin: 15px 0;">
							<p>
								엄청 신기하네요!<br>That's ______!
							</p>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script
		src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>

	<script>
const video = document.getElementById("videoPlayer");
const userSeq = document.getElementById("userSeq").value;
const videoSeq = document.getElementById("videoSeq").value;
const courseSeq = document.getElementById("courseSeq").value;
let alreadyCompleted = false;
let allowSave = false; // 저장시작여부

document.addEventListener("DOMContentLoaded", () => {
	axios.get("/course/stat/get", {
		  params: { userSeq, videoSeq, courseSeq }
		}).then(res => {
		  const stat = res.data;

		  const courseRate = stat && stat.courseRate ? stat.courseRate : 0;
		  const courseTime = stat && stat.courseTime ? stat.courseTime : 0;

		  const bar = document.querySelector(".progress-bar-custom");
		  bar.style.width = courseRate + "%";
		  bar.innerText = courseRate.toFixed(0) + "%";

		  alreadyCompleted = courseRate >= 99.9;

		  video.addEventListener("loadedmetadata", () => {
		    video.currentTime = alreadyCompleted ? video.duration - 0.1 : courseTime;
		    allowSave = true;

		    setInterval(() => {
		      if (!video.duration || !allowSave) return;

		      const currentTime = video.currentTime;
		      const progress = (currentTime / video.duration) * 100;

		      //실시간 프로그레스바
		      const bar = document.querySelector(".progress-bar-custom");
		      bar.style.width = progress.toFixed(2) + "%";
		      bar.innerText = progress.toFixed(0) + "%";
		      
		      if (alreadyCompleted || progress <= 0.1) return;
		      if (progress >= 99.9) alreadyCompleted = true;

		      axios.post("/course/stat/update", {
		        userSeq,
		        videoSeq,
		        courseSeq,
		        courseTime: Math.floor(currentTime),
		        courseRate: progress.toFixed(2),
		        lastTime: Math.floor(currentTime)
		      }).then(() => {
		        console.log(" 저장됨:", progress.toFixed(2));
		      });

		    }, 100
		    );
		  });
		}).catch(err => {
		  console.error("진행도 불러오기 실패:", err);
		});
	

	  const from = document.getElementById("from").value;
	  const closeBtn = document.querySelector(".travel-close-btn");

	  if (from === "user1") {
	    closeBtn.setAttribute("href", "/ui/user_registered_course?seq=" + courseSeq);
	  } else if (from === "user2") {
		closeBtn.setAttribute("href", "/ui/user_lecture?seq=" + courseSeq);
	  } else if (from === "uploader") {
	    closeBtn.setAttribute("href", "/upload/upload_course?seq=" + courseSeq);
	  }
	  
});

</script>
	<script>


</script>
</body>
</html>