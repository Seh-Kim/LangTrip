<!--
	정제균.
	
	신고목록을 조회하는 페이지.
	
	모바일 화면은 아이디 검색만?
	
-->

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>신고 목록</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" th:href="@{/css/admin_sidebar.css}">
  <style>
    /* Critical page-specific styles. Do not remove. */
    @charset "UTF-8";
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; display: flex; }
    /* Ensure main content fills space next to sidebar */
    .main-content { margin-left: 280px; padding: 2rem; flex: 1; display: flex; flex-direction: column; min-height: 100vh; }
    .page-header { background: #fff; padding: 2rem; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,.1); margin-bottom: 2rem; }
    .page-header h1 { color: #333; font-size: 2rem; margin-bottom: .5rem; }
    .page-header p { color: #666; font-size: 1.1rem; }
    /* Sticky search section */
    .search-section { 
      background: #f5f7fa; /* Match body background */
      padding: 2rem; 
      border-radius: 16px; 
      margin-bottom: 1rem; 
      position: sticky; 
      top: 0; 
      z-index: 10;
      box-shadow: 0 8px 16px rgba(0,0,0,.05);
    }
    .search-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; align-items: end; }
    .form-group { display: flex; flex-direction: column; }
    .form-group label { margin-bottom: .5rem; font-weight: 600; color: #333; }
    .form-group input, .form-group select { padding: .8rem; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem; transition: border-color .3s; }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; }
    .search-buttons { display: flex; gap: 1rem; justify-content: flex-end; }
    .btn { padding: .8rem 1.5rem; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; display: inline-flex; align-items: center; gap: .5rem; transition: all .3s; text-decoration: none; height: 38px; justify-content: center; }
    .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(102,126,234,.4); }
    .btn-secondary { background: #6c757d; color: #fff; }
    .btn-secondary:hover { background: #5a6268; }
    .sort-filter-bar { display: flex; justify-content: flex-end; align-items: center; gap: 1.5rem; padding: 1.5rem 1rem 1.5rem; }
    .sort-filter-bar label { font-weight: 600; color: #333; }
    .sort-filter-bar select { padding: .6rem 1rem; border-radius: 8px; border: 2px solid #e9ecef; font-size: 1rem; }
    .table-section-wrapper { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; background: #fff; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,.1); }
    .table-header { padding: 1.5rem 2rem; background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
    .table-header h3 { margin: 0; font-size: 1.3rem; }
    .table-stats { font-size: .9rem; opacity: .9; }
    .table-container { overflow-y: auto; flex-grow: 1; }
    .admin-table { width: 100%; border-collapse: collapse; }
    .admin-table th, .admin-table td { padding: 1rem 1.5rem; text-align: center; border-bottom: 1px solid #e9ecef; vertical-align: middle; white-space: normal; }
    
    .admin-table th { background: #f8f9fa; font-weight: 600; color: #333; position: sticky; top: 0; z-index: 1; }
    .pagination { display: flex; justify-content: center; padding: 1.5rem 0; flex-shrink: 0; }
    .pagination button, .pagination a { padding: 0.5rem 1rem; margin: 0 5px; border: 1px solid #ddd; border-radius: 5px; background-color: #f8f8f8; cursor: pointer; transition: background-color 0.3s; text-decoration: none; color: #333; }
    .pagination button:hover:not(.active), .pagination a:hover:not(.active) { background-color: #e0e0e0; }
    .pagination button.active, .pagination a.active { background-color: #667eea; color: white; border-color: #667eea; }
    .status-badge { display: inline-block; padding: 0.4rem 1rem; border-radius: 20px; font-size: 0.85rem; font-weight: 500; min-width: 60px; text-align: center; }
    .status-active { background: #d4edda; color: #155724; }
    .status-inactive { background: #f8d7da; color: #721c24; }
    .status-pending { background: #fff3cd; color: #856404; }
    .action-btn { }
    @media (max-width: 768px) {
      body { flex-direction: column; }
      .main-content { margin-left: 0; height: auto; }
      .search-form { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
<div th:replace="~{/layout/admin_sidebar :: sidebar}"></div>

<div class="main-content">
  <div class="page-header">
    <h1><i class="fas fa-flag"></i> 신고 관리</h1>
    <p>사용자 신고 내역을 조회하고 관리할 수 있습니다.</p>
  </div>

  <div class="search-section">
    <form id="searchForm" class="search-form" th:action="@{/admin/report/reportList}" method="get">
      <div class="form-group">
        <label for="contentType">콘텐츠 유형</label>
        <select name="contentType" id="contentType">
          <option value="" th:selected="${pReqDTO.contentType == null or pReqDTO.contentType == ''}">전체</option>
          <option value="강의" th:selected="${pReqDTO.contentType == '강의'}">강의</option>
          <option value="게시글" th:selected="${pReqDTO.contentType == '게시글'}">게시글</option>
        </select>
      </div>
      <div class="form-group">
        <label for="actionStatus">처리상태</label>
        <select name="actionStatus" id="actionStatus">
          <option value="" th:selected="${pReqDTO.actionStatus == null or pReqDTO.actionStatus == ''}">전체</option>
          <option value="미처리" th:selected="${pReqDTO.actionStatus == '미처리'}">미처리</option>
          <option value="제재" th:selected="${pReqDTO.actionStatus == '제재'}">제재</option>
          <option value="무제재" th:selected="${pReqDTO.actionStatus == '무제재'}">무제재</option>
        </select>
      </div>
      <div class="form-group">
        <label for="reportedUserId">피신고인 ID</label>
        <input type="text" name="reportedUserId" id="reportedUserId" th:value="${pReqDTO.reportedUserId}" placeholder="피신고인 ID 입력">
      </div>
      <div class="form-group">
        <label for="reporterId">신고인 ID</label>
        <input type="text" name="reporterId" id="reporterId" th:value="${pReqDTO.reporterId}" placeholder="신고인 ID 입력">
      </div>
      <div class="search-buttons">
        <button type="submit" class="btn btn-primary"><i class="fas fa-search"></i> 검색</button>
        <button type="button" class="btn btn-secondary" onclick="clearSearch()"><i class="fas fa-redo"></i> 초기화</button>
      </div>
    </form>
  </div>

  <div class="sort-filter-bar">
    <label for="sort">정렬</label>
    <select id="sort" name="sort">
      <option value="reportedAt,desc" th:selected="${pReqDTO.sort == 'reportedAt,desc'}">최신순</option>
      <option value="reportedAt,asc" th:selected="${pReqDTO.sort == 'reportedAt,asc'}">오래된순</option>
    </select>
    <label for="pageSize">항목 수</label>
    <select id="pageSize" name="pageSize">
      <option value="5" th:selected="${pReqDTO.size == 5}">5</option>
      <option value="10" th:selected="${pReqDTO.size == 10}">10</option>
      <option value="15" th:selected="${pReqDTO.size == 15}">15</option>
      <option value="20" th:selected="${pReqDTO.size == 20}">20</option>
      <option value="25" th:selected="${pReqDTO.size == 25}">25</option>
      <option value="30" th:selected="${pReqDTO.size == 30}">30</option>
    </select>
  </div>

  <div class="table-section-wrapper">
    <div class="table-header">
      <h3>신고 목록</h3>
      <span class="table-stats" th:text="|총 ${pResDTO.totalCnt}건|">총 00건</span>
    </div>
    <div class="table-container">
      <table class="admin-table">
        <thead>
          <tr>
            <th>번호</th>
            <th>신고일</th>
            <th>콘텐츠 유형</th>
            <th>제목</th>
            <th>피신고인 ID</th>
            <th>신고인 ID</th>
            <th>신고 사유</th>
            <th>처리상태</th>
          </tr>
        </thead>
        <tbody>
          <tr th:each="report, stat : ${pResDTO.list}"
              th:attr="
                data-reporter-reasons=${report.reporterReasons},
                data-report-id=${report.reportId}, 
                data-reported-at=${report.reportedAt}, 
                data-content-type=${report.contentType}, 
                data-title=${report.title}, 
                data-reporter-id=${report.reporterId}, 
                data-reported-user-id=${report.reportedUserId}, 
                data-action-status=${report.actionStatus}, 
                data-reported-user-status=${report.reportedUserStatus},
                data-admin-checked-reason=${#strings.arrayJoin(report.adminCheckedReason, ',')},
                data-admin-custom-reason-txt=${report.adminCustomReasonTxt},
                data-admin-acted-at=${report.adminActedAtStr}"
              class="report-row" style="cursor: pointer;">
            <td th:text="${(pResDTO.currentPage - 1) * pReqDTO.size + stat.index + 1}"></td>
            <td th:text="${report.reportedAt}"></td>
            <td th:text="${report.contentType}"></td>
            <td th:text="${report.title}"></td>
            <td th:text="${report.reportedUserId}"></td>
            <td th:text="${report.reporterId}"></td>
            <td th:text="${report.getReporterReasonsSimple()}"></td>
            <td>
              <span th:classappend="${report.actionStatus == '미처리'} ? 'status-pending' : (${report.actionStatus == '제재'} ? 'status-inactive' : 'status-active')" class="status-badge" th:text="${report.actionStatus}"></span>
            </td>
          </tr>
          <tr th:if="${pResDTO.list == null or pResDTO.list.empty}">
            <td colspan="8">신고 내역이 없습니다.</td>
          </tr>
        </tbody>
      </table>
    </div>
    <nav class="pagination">
      <a th:if="${pResDTO.currentPage > 1}" th:href="@{/admin/report/reportList(
        page=1,
        reporterId=${pReqDTO.reporterId},
        reportedUserId=${pReqDTO.reportedUserId},
        contentType=${pReqDTO.contentType},
        actionStatus=${pReqDTO.actionStatus},
        sort=${pReqDTO.sort},
        size=${pReqDTO.size}
      )}">≪</a>
      <a th:if="${pResDTO.currentPage > 1}" th:href="@{/admin/report/reportList(
        page=${pResDTO.currentPage - 1},
        reporterId=${pReqDTO.reporterId},
        reportedUserId=${pReqDTO.reportedUserId},
        contentType=${pReqDTO.contentType},
        actionStatus=${pReqDTO.actionStatus},
        sort=${pReqDTO.sort},
        size=${pReqDTO.size}
      )}">＜</a>
      <a th:each="p : ${#numbers.sequence(pResDTO.startPage, pResDTO.endPage)}"
         th:classappend="${p == pResDTO.currentPage} ? 'active' : ''"
         th:href="@{/admin/report/reportList(
           page=${p},
           reporterId=${pReqDTO.reporterId},
           reportedUserId=${pReqDTO.reportedUserId},
           contentType=${pReqDTO.contentType},
           actionStatus=${pReqDTO.actionStatus},
           sort=${pReqDTO.sort},
           size=${pReqDTO.size}
         )}" th:text="${p}">1</a>
      <a th:if="${pResDTO.currentPage < pResDTO.totalPages}" th:href="@{/admin/report/reportList(
        page=${pResDTO.currentPage + 1},
        reporterId=${pReqDTO.reporterId},
        reportedUserId=${pReqDTO.reportedUserId},
        contentType=${pReqDTO.contentType},
        actionStatus=${pReqDTO.actionStatus},
        sort=${pReqDTO.sort},
        size=${pReqDTO.size}
      )}">＞</a>
      <a th:if="${pResDTO.currentPage < pResDTO.totalPages}" th:href="@{/admin/report/reportList(
        page=${pResDTO.totalPages},
        reporterId=${pReqDTO.reporterId},
        reportedUserId=${pReqDTO.reportedUserId},
        contentType=${pReqDTO.contentType},
        actionStatus=${pReqDTO.actionStatus},
        sort=${pReqDTO.sort},
        size=${pReqDTO.size}
      )}">≫</a>
    </nav>
  </div>
</div>

<div th:replace="~{/admin/report/reportDetailModal :: reportDetailModalContent}"></div>
<div th:replace="~{/admin/report/reportDetailModal :: confirmModalContent}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>
<script th:inline="javascript">
document.addEventListener('DOMContentLoaded', function() {
    const searchForm = document.getElementById('searchForm');
    const sortSelect = document.getElementById('sort');
    const pageSizeSelect = document.getElementById('pageSize');
    const reportDetailModalEl = document.getElementById('reportDetailModal');
    const reportDetailModal = new bootstrap.Modal(reportDetailModalEl);

    // Elements for penalty/status control
    const noPenaltyRadio = document.getElementById("noPenalty");
    const penaltyRadio = document.getElementById("penalty");
    const warningRadio = document.getElementById("status-warning");
    const banRadio = document.getElementById("status-ban");
    const reasonCheckboxes = document.querySelectorAll("#reason1, #reason2, #reason3, #reason4");
    const reasonEtc = document.getElementById("reason4");
    const customReasonInput = document.getElementById("customReason");

    // Always disabled items
    document.getElementById("status-normal").disabled = true;
    document.getElementById("status-auto").disabled = true;
    document.getElementById("status-leave").disabled = true;

    function setInputsDisabled(disabled) {
        warningRadio.disabled = disabled;
        banRadio.disabled = disabled;
        reasonCheckboxes.forEach(checkbox => checkbox.disabled = disabled);
        customReasonInput.disabled = disabled || !reasonEtc.checked;
    }

    function updateUrlAndSubmit() {
        const url = new URL(window.location.origin + window.location.pathname);
        const formData = new FormData(searchForm);

        for (const [key, value] of formData.entries()) {
            if (value) { // Only add if value is not empty
                url.searchParams.set(key, value);
            } else {
                url.searchParams.delete(key); // Remove if empty
            }
        }
        url.searchParams.set('sort', sortSelect.value);
        url.searchParams.set('size', pageSizeSelect.value);
        url.searchParams.set('page', 1); // Reset to page 1 on new search/filter

        window.location.href = url.toString(); // Full page reload for simplicity with Thymeleaf
    }

    searchForm.addEventListener('submit', function(e) {
        e.preventDefault();
        updateUrlAndSubmit();
    });

    sortSelect.addEventListener('change', updateUrlAndSubmit);
    pageSizeSelect.addEventListener('change', updateUrlAndSubmit);

    window.clearSearch = function() {
        document.getElementById('contentType').value = '';
        document.getElementById('actionStatus').value = '';
        document.getElementById('reportedUserId').value = '';
        document.getElementById('reporterId').value = '';
        document.getElementById('sort').value = 'reportedAt,desc'; // Default sort
        document.getElementById('pageSize').value = '10'; // Default page size
        updateUrlAndSubmit();
    }

    // 한 행 클릭 시 상세 모달 띄우기 및 데이터 바인딩
    document.querySelectorAll('.report-row').forEach((row) => {
        row.addEventListener('click', (e) => {
            const data = e.currentTarget.dataset;
                    
            // 모달 내부 텍스트 채우기
            document.getElementById('modal-reason').innerText = data.reporterReasons;
            document.getElementById('modal-date').innerText = data.reportedAt;
            document.getElementById('modal-contentType').innerText = data.contentType;
            document.getElementById('modal-title').innerText = data.title;
            // document.getElementById('modal-title').href = '/post/' + data.reportId; // 필요시
            document.getElementById('modal-reporterId').innerText = data.reporterId;
            document.getElementById('modal-reportedUserId').innerText = data.reportedUserId;
            document.getElementById('modal-actionStatus').innerText = data.actionStatus;
            document.getElementById('modal-adminActedAt').innerText = data.adminActedAt;
            document.getElementById('modal-reportedUserStatus').innerText = data.reportedUserStatus;

            // Set penalty type radio
            if (data.actionStatus === '무제재') {
                noPenaltyRadio.checked = true;
                setInputsDisabled(true);
            } else if (data.actionStatus === '제재') {
                penaltyRadio.checked = true;
                setInputsDisabled(false);
            } else { // Default to no penalty if status is not clear
                noPenaltyRadio.checked = true;
                setInputsDisabled(true);
            }

            // Set account status radio
            document.querySelectorAll('input[name="accountStatus"]').forEach(radio => {
                radio.checked = (radio.value === data.reportedUserStatus);
            });

            // Set admin checked reasons
            reasonCheckboxes.forEach(checkbox => {
                checkbox.checked = false; // Reset all first
            });
            if (data.adminCheckedReason) {
                const checkedReasons = data.adminCheckedReason.split(',');
                checkedReasons.forEach(reason => {
                    if (reason === '욕설') document.getElementById('reason1').checked = true;
                    if (reason === '음란물') document.getElementById('reason2').checked = true;
                    if (reason === '허위') document.getElementById('reason3').checked = true;
                    if (reason === '기타') document.getElementById('reason4').checked = true;
                });
            }

            // Set custom reason
            customReasonInput.value = data.adminCustomReasonTxt || '';
            customReasonInput.disabled = !reasonEtc.checked; // Ensure disabled state is correct

            // 모달 열기
            reportDetailModal.show();
        });
    });

    // 무제재 선택 시
    noPenaltyRadio.addEventListener("change", () => {
      if (noPenaltyRadio.checked) {
        setInputsDisabled(true);
      }
    });

    // 제재 선택 시
    penaltyRadio.addEventListener("change", () => {
      if (penaltyRadio.checked) {
        setInputsDisabled(false);
      }
    });

    // 기타 체크박스에 따른 직접 입력 필드 제어
    reasonEtc.addEventListener("change", () => {
      if (penaltyRadio.checked) {
        customReasonInput.disabled = !reasonEtc.checked;
        if (reasonEtc.checked) {
          customReasonInput.focus();
        } else {
          customReasonInput.value = "";
        }
      }
    });

    // 적용 버튼 클릭 시 검증
    document.getElementById("applyBtn").addEventListener("click", () => {
      if (penaltyRadio.checked && reasonEtc.checked && customReasonInput.value.trim() === "") {
        reasonEtc.checked = false;
        customReasonInput.disabled = true;
        customReasonInput.value = "";
      }

      const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'), {
        backdrop: false,
        keyboard: false,
      });
      confirmModal.show();
    });

    // 확인 버튼 → 모달 닫기 처리
    document.getElementById("confirmApplyBtn").addEventListener("click", () => {
      const modal1 = bootstrap.Modal.getInstance(document.getElementById('reportDetailModal'));
      const modal2 = bootstrap.Modal.getInstance(document.getElementById('confirmModal'));

      modal2.hide();
      modal1.hide();

      console.log("신고 처리 적용됨");
    });
});
</script>
</body>
</html>
