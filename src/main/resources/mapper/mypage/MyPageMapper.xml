<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.sist.e_learning.mypage.MyPageMapper">

	<!-- 대시보드 요약 정보 조회 -->
	<select id="selectMyPageSummary"
	        parameterType="long"
	        resultType="kr.co.sist.e_learning.mypage.MyPageDTO">
	  SELECT
	    u.user_seq AS userSeq,
	    u.nickname AS nickname,
	    u.email,
	    u.profile AS profile,
	    u.social_id AS socialId,
	    3 AS completedCourses,
	    120 AS totalStudyTime,
	    95.5 AS quizAccuracy,
	    '실버' AS donationLevel,
	    (
	      SELECT NVL(SUM(d.donation_amount), 0)
	      FROM donations d
	      JOIN mile_wallet mw ON d.wallet_seq = mw.wallet_seq
	      WHERE mw.user_seq = u.user_seq
	    ) AS totalDonation
	  FROM users u
	  WHERE u.user_seq = #{userSeq}
	</select>


<!-- 총 후원액 합계 -->
<select id="selectTotalDonationByUserSeq"
        parameterType="long"
        resultType="int">
  SELECT NVL(SUM(d.donation_amount), 0)
  FROM donations d
  JOIN mile_wallet mw ON d.wallet_seq = mw.wallet_seq
  WHERE mw.user_seq = #{userSeq}
</select>



  <!-- 내 정보 조회 -->
  <select id="selectUserInfo"
          parameterType="long"
          resultType="kr.co.sist.e_learning.mypage.MyPageDTO">
    SELECT 
      user_seq AS userSeq,
      email,
      password,
      nickname,
      status,
      profile,
      social_id AS socialId,
      social_provider AS socialProvider
    FROM users
    WHERE user_seq = #{userSeq}
  </select>

  <!-- 프로필 경로 조회 -->
  <select id="selectProfilePath"
          parameterType="long"
          resultType="string">
    SELECT profile
    FROM users
    WHERE user_seq = #{userSeq}
  </select>

  <!-- 사용자 프로필 경로 업데이트 -->
  <update id="updateProfile"
          parameterType="map">
    UPDATE users
    SET profile = #{profile}
    WHERE user_seq = #{userSeq}
  </update>

<!-- 구독 목록 조회 -->
<select id="selectSubscriptions"
        parameterType="long"
        resultType="kr.co.sist.e_learning.mypage.SubscriptionDTO">
  SELECT
    uf.following_id                     AS instructorId,
    u.nickname                          AS instructorName,
    TO_CHAR(uf.subscribed_at,'YYYY-MM-DD') AS subscribedAt
  FROM user_follow uf
  JOIN users u 
    ON uf.following_id = u.user_seq
  WHERE uf.follower_id = #{userSeq}
</select>

<!-- 수강 내역 조회 -->
<select id="selectLectureHistory"
        parameterType="long"
        resultType="kr.co.sist.e_learning.mypage.LectureHistoryDTO">
  SELECT
    l.lecture_seq AS lectureSeq,
    l.lecture_title AS lectureTitle,
    l.instructor_name AS instructorName,
    lh.enrollment_date AS enrollmentDate,
    lh.completion_date AS completionDate,
    lh.progress AS progress
  FROM lectures l
  JOIN lecture_history lh ON l.lecture_seq = lh.lecture_seq
  WHERE lh.user_seq = #{userSeq}
</select>

<!-- 내 강의 조회 -->
<select id="selectMyLectures"
        parameterType="long"
        resultType="kr.co.sist.e_learning.mypage.LectureHistoryDTO">
  SELECT
    l.lecture_seq AS lectureSeq,
    l.lecture_title AS lectureTitle,
    l.instructor_name AS instructorName,
    l.created_at AS enrollmentDate
  FROM lectures l
  WHERE l.instructor_seq = #{userSeq}
</select>



  <!-- 구독 취소 -->
  <delete id="deleteSubscription"
          parameterType="map">
    DELETE FROM user_follow
    WHERE follower_id = #{userSeq}
      AND following_id = #{instructorId}
  </delete>

  <!-- 사용자 계좌 정보 조회 -->
  <select id="selectUserAccount"
          parameterType="long"
          resultType="kr.co.sist.e_learning.mypage.UserAccountDTO">
    SELECT
      account_seq AS accountSeq,
      user_seq AS userSeq,
      bank_code AS bankCode,
      account_num AS accountNum,
      holder_name AS holderName,
      verified,
      created_at AS createdAt
    FROM user_account
    WHERE user_seq = #{userSeq}
  </select>

  <!-- 사용자 계좌 정보 삽입 -->
  <insert id="insertUserAccount"
          parameterType="kr.co.sist.e_learning.mypage.UserAccountDTO">
    INSERT INTO user_account (account_seq, user_seq, bank_code, account_num, holder_name)
    VALUES (SYS_GUID(), #{userSeq}, #{bankCode}, #{accountNum}, #{holderName})
  </insert>

  <!-- 사용자 계좌 정보 업데이트 -->
  <update id="updateUserAccount"
          parameterType="kr.co.sist.e_learning.mypage.UserAccountDTO">
    UPDATE user_account
    SET
      bank_code = #{bankCode},
      account_num = #{accountNum},
      holder_name = #{holderName}
    WHERE user_seq = #{userSeq}
  </update>

  <!-- 사용자 계좌 정보 삭제 -->
  <delete id="deleteUserAccount"
          parameterType="long">
    DELETE FROM user_account
    WHERE user_seq = #{userSeq}
  </delete>

</mapper>
