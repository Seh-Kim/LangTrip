<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.sist.e_learning.course.CourseMapper">

  <!-- Base SQL for User Course Selection -->
  <sql id="userCourseColumns">
    c.course_seq,
    c.title,
    c.category,
    u.nickname AS instructor_nickname,
    -- Dummy values for rating, students, prices, duration for now
    -- These should come from actual data or calculated fields
    4.5 AS rating,
    (SELECT COUNT(*) FROM user_course_enrollment WHERE course_seq = c.course_seq) AS students,
    100000 AS original_price,
    80000 AS current_price,
    c.difficulty,
    '10시간' AS duration,
    c.thumbnail_name,
    c.thumbnail_path
  </sql>

  <sql id="userCourseJoin">
    FROM course c
    JOIN "C##UNDER".USERS u ON c.user_id = u.USER_ID
  </sql>

  <sql id="userCourseWhere">
    <where>
      c.is_public = 'Y'
      AND c.status = 'ACTIVE'
      <if test="searchTerm != null and searchTerm != ''">
        AND (c.title LIKE '%' || #{searchTerm} || '%'
             OR u.nickname LIKE '%' || #{searchTerm} || '%')
      </if>
      <if test="category != null and category != ''">
        AND c.category = #{category}
      </if>
      <if test="difficulty != null and difficulty != ''">
        AND c.difficulty = #{difficulty}
      </if>
      <if test="priceRange != null and priceRange != ''">
        <choose>
          <when test="priceRange == 'free'">
            AND 0 = 0 -- Assuming free courses have 0 price, adjust if needed
          </when>
          <when test="priceRange == '0-50000'">
            AND 80000 BETWEEN 0 AND 50000 -- Dummy price, adjust to actual price column
          </when>
          <when test="priceRange == '50000-100000'">
            AND 80000 BETWEEN 50001 AND 100000 -- Dummy price, adjust to actual price column
          </when>
          <when test="priceRange == '100000+'">
            AND 80000 > 100000 -- Dummy price, adjust to actual price column
          </when>
        </choose>
      </if>
    </where>
  </sql>

  <!-- 1. 사용자 강의 목록 조회 (검색, 필터, 정렬, 페이징 포함) -->
  <select id="selectUserCourses" resultType="kr.co.sist.e_learning.course.UserCourseListDTO" parameterType="map">
    SELECT
      <include refid="userCourseColumns"/>
    <include refid="userCourseJoin"/>
    <include refid="userCourseWhere"/>
    <if test="orderBy != null and orderBy != ''">
      ORDER BY
      <choose>
        <when test="orderBy == 'popular'">students DESC</when>
        <when test="orderBy == 'newest'">c.upload_date DESC</when>
        <when test="orderBy == 'rating'">rating DESC</when>
        <when test="orderBy == 'price-low'">current_price ASC</when>
        <when test="orderBy == 'price-high'">current_price DESC</when>
        <otherwise>c.upload_date DESC</otherwise> <!-- Default sort -->
      </choose>
    </if>
    OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY
  </select>

  <!-- 2. 사용자 강의 목록 전체 개수 조회 (검색 조건 포함) -->
  <select id="countUserCourses" resultType="int" parameterType="map">
    SELECT COUNT(*)
    <include refid="userCourseJoin"/>
    <include refid="userCourseWhere"/>
  </select>

</mapper>