<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.sist.e_learning.admin.course.AdminCourseMapper">

  <!-- Base SQL for Course Selection -->
  <sql id="courseColumns">
    c.course_seq,
    c.title,
    c.introduction,
    c.USER_ID AS instructor_id,
    u.nickname AS instructor_nickname,
    c.upload_date,
    c.thumbnail_path,
    c.thumbnail_name,
    c.is_public,
    c.category,
    c.status
  </sql>

  <sql id="courseJoin">
    FROM course c
    JOIN "C##UNDER".USERS u ON c.user_id = u.USER_ID
  </sql>

  <sql id="courseWhere">
    <where>
      <if test="title != null and title != ''">
        AND c.title LIKE '%' || #{title} || '%'
      </if>
      <if test="category != null and category != ''">
        AND c.category = #{category}
      </if>
      <if test="!includeInactive">
        AND c.status = 'ACTIVE'
      </if>
      <if test="includeInactive">
        AND c.status IN ('ACTIVE', 'INACTIVE')
      </if>
    </where>
  </sql>

  <!-- 1. 강의 목록 조회 (검색, 정렬, 페이징 포함) -->
  <select id="selectCourses" resultType="kr.co.sist.e_learning.admin.course.AdminCourseDTO" parameterType="map">
    SELECT
      <include refid="courseColumns"/>
    <include refid="courseJoin"/>
    <include refid="courseWhere"/>
    <if test="orderBy != null and orderBy != ''">
      ORDER BY
      <choose>
        <when test="orderBy == 'upload_date'">c.upload_date</when>
        <otherwise>c.upload_date</otherwise> <!-- Default sort -->
      </choose>
      <if test="sort == 'desc'">DESC</if>
      <if test="sort == 'asc'">ASC</if>
    </if>
    OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY
  </select>

  <!-- 2. 강의 목록 전체 개수 조회 (검색 조건 포함) -->
  <select id="countCourses" resultType="int" parameterType="map">
    SELECT COUNT(*)
    <include refid="courseJoin"/>
    <include refid="courseWhere"/>
  </select>

  <!-- 3. 강의 상세 조회 -->
  <select id="selectCourseDetail" resultType="kr.co.sist.e_learning.admin.course.AdminCourseDTO" parameterType="string">
    SELECT
      <include refid="courseColumns"/>
    <include refid="courseJoin"/>
    WHERE c.course_seq = #{courseSeq}
  </select>

  <!-- 4. 공개 여부 수정 -->
  <update id="updateCourseVisibility" parameterType="map">
    UPDATE course
    SET is_public = #{isPublic}
    WHERE course_seq = #{courseSeq}
  </update>

  <!-- 5. 강의 상태 수정 (소프트 삭제 포함) -->
  <update id="updateCourseStatus" parameterType="map">
    UPDATE course
    SET status = #{status}
    WHERE course_seq = #{courseSeq}
  </update>

</mapper>
