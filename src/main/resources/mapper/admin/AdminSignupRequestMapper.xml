<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.sist.e_learning.admin.signup_req.AdminSignupRequestMapper">

<select id="listPendingRequests" resultMap="signupRequestMap">
  SELECT * FROM ADMIN_SIGNUP_REQUEST
  WHERE STATUS = 'PENDING'
  ORDER BY REQUEST_DATE DESC
</select>

<resultMap id="signupRequestMap" type="kr.co.sist.e_learning.admin.signup_req.AdminSignupRequestDTO">
  <id property="requestId" column="REQUEST_ID"/>
  <result property="adminName" column="ADMIN_NAME"/>
  <result property="adminId" column="ADMIN_ID"/>
  <result property="email" column="EMAIL"/>
  <result property="phone" column="PHONE"/>
  <result property="passwordHash" column="PASSWORD_HASH"/>
  <result property="status" column="STATUS"/>
  <result property="requestDate" column="REQUEST_DATE"/>
</resultMap>


 <select id="getRequestById" parameterType="String" resultMap="signupRequestMap">
  SELECT * FROM ADMIN_SIGNUP_REQUEST
  WHERE REQUEST_ID = #{requestId}
</select>

  <!-- 3. 상태 승인 처리 -->
  <update id="updateStatusApproved" parameterType="String">
    UPDATE ADMIN_SIGNUP_REQUEST
    SET STATUS = 'APPROVED'
    WHERE REQUEST_ID = #{requestId}
  </update>

  <!-- 4. 상태 미승인 처리 -->
  <update id="updateStatusRejected" parameterType="String">
    UPDATE ADMIN_SIGNUP_REQUEST
    SET STATUS = 'REJECTED'
    WHERE REQUEST_ID = #{requestId}
  </update>

  <!-- 5. 권한 목록 -->
  <select id="getRolesByRequestId" parameterType="String" resultType="String">
    SELECT ROLE_CODE
    FROM ADMIN_SIGNUP_ROLE
    WHERE REQUEST_ID = #{requestId}
  </select>

  <!-- 6. 요청 삭제 -->
  <delete id="deleteSignupRequest" parameterType="String">
  DELETE FROM ADMIN_SIGNUP_REQUEST
  WHERE REQUEST_ID = #{requestId}
</delete>

<delete id="deleteSignupRole" parameterType="String">
  DELETE FROM ADMIN_SIGNUP_ROLE
  WHERE REQUEST_ID = #{requestId}
</delete>

  <!-- 7. 승인 시 관리자 등록 -->
<insert id="insertAdmin" parameterType="kr.co.sist.e_learning.admin.signup_req.AdminSignupRequestDTO">
  INSERT INTO ADMINS (
    ADMIN_ID, PASSWORD, ADMIN_NAME, EMAIL, PHONE, STATUS, REG_DATE, CHECK_AUTH
  ) VALUES (
    #{adminId, jdbcType=VARCHAR},
    #{passwordHash, jdbcType=VARCHAR},
    #{adminName, jdbcType=VARCHAR},
    #{email, jdbcType=VARCHAR},
    #{phone, jdbcType=VARCHAR},
    'Y',
    SYSTIMESTAMP,
    'N'
  )
</insert>


  <!-- 8. 승인 시 권한 등록 -->
  <insert id="insertAdminRole" parameterType="map">
    INSERT INTO ADMIN_ROLE (
      ADMIN_ID, ROLE_CODE
    ) VALUES (
      #{adminId}, #{roleCode}
    )
  </insert>

</mapper>
